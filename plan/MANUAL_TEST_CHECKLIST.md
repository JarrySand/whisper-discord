# 🧪 手動テストチェックリスト

> **目的**: システム全体のE2Eテストを手動で実施する
>
> **所要時間**: 約30分
>
> **前提条件**: Bot と Whisper API が起動済み

---

## 📋 テスト環境準備

### 前提チェック

- [x] Node.js 20+ がインストールされている
- [x] Python 3.10+ がインストールされている
- [x] Discord テスト用サーバーを用意
- [x] `.env` ファイルを設定済み
- [ ] テスト用VCに2人以上参加可能

### Discord サーバー設定

- [x] テスト専用サーバーを作成（または既存を使用）
- [x] テキストチャンネル `#bot-output` を作成
- [x] ボイスチャンネル `🎤テスト用VC` を作成
- [x] Bot を招待（必要な権限を付与）
  - [x] ボイスチャンネルの接続
  - [x] ボイスチャンネルで発言
  - [x] メッセージを送信
  - [x] 埋め込みリンク

---

## 🚀 起動確認テスト

### テスト A-1: Whisper API 起動

**手順:**
```powershell
cd whisper-api
.\venv\Scripts\Activate.ps1
uvicorn src.main:app --reload --port 8000
```

**確認項目:**
- [x] エラーなく起動する
- [x] `Model loaded` メッセージが表示される
- [x] `http://localhost:8000/health` にアクセスして JSON が返る

**期待結果:**
```json
{
  "status": "ok",
  "model_loaded": true,
  "model_name": "large-v3",
  "device": "cuda" または "cpu"
}
```

### テスト A-2: Bot 起動

**手順:**
```powershell
cd bot
npm run dev
```

**確認項目:**
- [x] エラーなく起動する
- [x] `Bot is ready!` または類似のメッセージが表示される
- [x] Discord でオンライン表示される

---

## 🎤 基本機能テスト

### テスト B-1: `/join` コマンド

**手順:**
1. VCに自分が参加する
2. テキストチャンネルで `/join` を実行

**確認項目:**
- [x] Bot が同じ VC に参加する
- [x] 参加成功メッセージが表示される
- [x] コンソールにエラーが出ていない

**結果:** ✅ Pass / ⬜ Fail

**備考:**
```
@discordjs/voice 最新版と @snazzah/davey のインストールが必要だった
```

---

### テスト B-2: `/join` 出力チャンネル指定

**手順:**
1. VCに参加する
2. `/join output_channel:#bot-output` を実行

**確認項目:**
- [x] Bot が VC に参加する
- [x] 出力先が `#bot-output` に設定される旨が表示される

**結果:** ✅ Pass / ⬜ Fail

---

### テスト B-3: `/status` コマンド

**手順:**
1. Bot が VC に参加している状態で `/status` を実行

**確認項目:**
- [x] ステータス情報が表示される
- [x] API 接続状態が表示される
- [x] キュー状態が表示される

**結果:** ✅ Pass / ⬜ Fail

---

### テスト B-4: `/leave` コマンド

**手順:**
1. Bot が VC に参加している状態で `/leave` を実行

**確認項目:**
- [x] Bot が VC から離脱する
- [x] セッション情報（時間、発話数など）が表示される
- [x] ログファイルパスが表示される

**結果:** ✅ Pass / ⬜ Fail

---

## 🎙️ 文字起こしテスト

### テスト C-1: 単一話者の発話

**手順:**
1. `/join output_channel:#bot-output` で参加
2. VCで「こんにちは、テストです」とゆっくり発話
3. 約5-10秒待つ

**確認項目:**
- [x] `#bot-output` に文字起こし結果が投稿される
- [x] 話者名（自分のニックネーム）が表示される
- [x] 発話内容が概ね正しい

**遅延時間:** 約10-15秒

**結果:** ✅ Pass / ⬜ Fail

**実際の出力:**
```
🎤 Suna 9:26:44 PM
お、文字起こし結果が表示されるのか。
```

---

### テスト C-2: 長文発話

**手順:**
1. Bot が参加した状態で、10秒以上連続で話す

**確認項目:**
- [x] 発話がセグメント分割される
- [x] 複数のメッセージに分かれて投稿される
- [x] 内容の途切れや欠落がない

**結果:** ✅ Pass / ⬜ Fail

**備考:** 10〜20秒程度のセグメントに自動分割されることを確認

---

### テスト C-3: 複数話者（T-1 実機テスト）

**手順:**
1. ユーザー A, B, C が同じ VC に参加
2. `/join` で Bot を参加させる
3. 順番に発話:
   - A: 「私はAです」
   - B: 「私はBです」
   - C: 「私はCです」

**確認項目:**
- [x] 各発話が正しい話者名で表示される
- [x] A の発話に A の名前が付く
- [x] B の発話に B の名前が付く
- [ ] C の発話に C の名前が付く（2人でテスト）

**結果:** ✅ Pass / ⬜ Fail

**備考:** Suna と Akari の2人でテスト。各話者が正しく識別された。

---

### テスト C-4: 同時発話

**手順:**
1. 2人以上が同時に話し始める
2. 結果を確認

**確認項目:**
- [x] 各話者の発話が分離される
- [x] 混ざったり、誤った話者に割り当てられていない

**結果:** ✅ Pass / ⬜ Fail

---

## 📝 出力形式テスト

### テスト D-1: Standard フォーマット

**設定:** `.env` で `OUTPUT_DISCORD_FORMAT=standard`

**手順:**
1. Bot を再起動して発話

**確認項目:**
- [x] `🎤 **表示名** <タイムスタンプ>` 形式で表示される

**サンプル出力:**
```
🎤 **Alice** <t:1733389200:T>
こんにちは、テストです。
```

**結果:** ✅ Pass / ⬜ Fail

**備考:** 初回テスト時に確認済み

---

### テスト D-2: Compact フォーマット

**設定:** `.env` で `OUTPUT_DISCORD_FORMAT=compact`

**確認項目:**
- [ ] `[HH:MM:SS] 表示名: テキスト` 形式で表示される

**サンプル出力:**
```
[10:23:14] Alice: こんにちは、テストです。
```

**結果:** ⬜ Pass / ⬜ Fail

---

### テスト D-3: Embed フォーマット

**設定:** `.env` で `OUTPUT_DISCORD_FORMAT=embed`

**確認項目:**
- [ ] Discord Embed 形式で表示される
- [ ] 話者名がヘッダーに表示される

**結果:** ⬜ Pass / ⬜ Fail

---

## 📁 ファイル出力テスト

### テスト E-1: ログファイル出力

**手順:**
1. セッション終了後、`bot/logs/` ディレクトリを確認

**確認項目:**
- [x] `logs/YYYY-MM-DD/` ディレクトリが存在
- [x] `session-XXX-HH-MM-SS.log` ファイルが存在
- [x] ヘッダー・フッターが正しく記載されている
- [x] 発話ログが記録されている

**結果:** ✅ Pass / ⬜ Fail

---

### テスト E-2: JSON ファイル出力

**確認項目:**
- [x] `session-XXX.json` ファイルが存在
- [x] 正しい JSON 形式
- [x] `segments` 配列に発話データがある
- [x] `participants` に参加者情報がある

**結果:** ✅ Pass / ⬜ Fail

---

### テスト E-3: Markdown ファイル出力

**確認項目:**
- [x] `session-XXX.md` ファイルが存在
- [x] セッション情報テーブルがある
- [x] 会話ログセクションがある
- [x] 統計セクションがある

**結果:** ✅ Pass / ⬜ Fail

---

## 🔄 エラー処理テスト

### テスト F-1: Whisper API 停止時

**手順:**
1. Bot が VC に参加している状態で発話
2. Whisper API を Ctrl+C で停止
3. 発話を続ける
4. `/status` で確認

**確認項目:**
- [x] Bot がクラッシュしない
- [x] サーキットブレーカー発動（`/status` で確認）
- [x] コンソールにエラーログが出る

**結果:** ✅ Pass / ⬜ Fail

**備考:** リトライ3回 → 失敗カウント (1/5, 2/5...) が確認できた

---

### テスト F-2: Whisper API 復帰

**手順:**
1. テスト F-1 の続き
2. Whisper API を再起動
3. しばらく待つ（30秒程度）
4. 発話して確認

**確認項目:**
- [x] API 再接続される
- [x] 文字起こしが再開される
- [x] （あれば）オフラインキューが処理される

**結果:** ✅ Pass / ⬜ Fail

**備考:** サーキットブレーカー: OPEN → HALF_OPEN → CLOSED と正常に遷移確認

---

### テスト F-3: VC から全員離脱

**手順:**
1. Bot 以外の全員が VC を離脱
2. Bot の挙動を確認

**確認項目:**
- [ ] Bot が自動的に離脱する（設定による）
- [x] またはエラーなく待機を続ける
- [ ] セッションが正常に保存される（/leave で終了）

**結果:** ✅ Pass / ⬜ Fail

**備考:** 自動離脱機能を実装済み。10分間誰もいない状態が続くと自動離脱。タイマー開始・キャンセルのログ出力を確認。

---

## ⏱️ 負荷テスト

### テスト G-1: 10分間連続セッション

**手順:**
1. `/join` で Bot を参加させる
2. 10分間、適度に発話を続ける
3. `/leave` で終了

**確認項目:**
- [ ] 10分間安定して動作する
- [ ] メモリ使用量が異常に増加しない
- [ ] 遅延が悪化しない（30秒以内を維持）
- [ ] すべての発話が記録される

**開始時刻:** ________
**終了時刻:** ________
**発話数:** ________件

**結果:** ⬜ Pass / ⬜ Fail

---

### テスト G-2: 高頻度発話

**手順:**
1. 3人で連続的に発話（休みなく交互に話す）
2. 5分間続ける

**確認項目:**
- [ ] キューが処理しきれる
- [ ] 遅延が30秒を超えない
- [ ] 発話の欠落がない

**結果:** ⬜ Pass / ⬜ Fail

---

## 📊 テスト結果サマリー

### 環境情報

| 項目 | 値 |
|------|-----|
| テスト日 | YYYY-MM-DD |
| OS | Windows XX |
| Node.js | vXX.X.X |
| Python | 3.XX.X |
| Whisper Model | large-v3 |
| Device | CPU / GPU |

### 結果集計

| カテゴリ | Pass | Fail | 未実施 |
|---------|------|------|--------|
| 起動確認 (A) | | | |
| 基本機能 (B) | | | |
| 文字起こし (C) | | | |
| 出力形式 (D) | | | |
| ファイル出力 (E) | | | |
| エラー処理 (F) | | | |
| 負荷テスト (G) | | | |
| **合計** | | | |

### 遅延測定結果

| 測定 | 値 |
|------|-----|
| 平均遅延 | ____秒 |
| 最大遅延 | ____秒 |
| 最小遅延 | ____秒 |

### 発見した問題

| # | 重要度 | 問題 | 再現手順 | 備考 |
|---|--------|------|---------|------|
| 1 | 高/中/低 | | | |
| 2 | | | | |
| 3 | | | | |

---

## ✅ 合格基準

すべてのテストが以下を満たすこと：

- [ ] A〜E カテゴリの全テストが Pass
- [ ] F カテゴリ（エラー処理）の全テストが Pass
- [ ] G-1 10分セッションが安定動作
- [ ] 平均遅延が15秒以内
- [ ] 最大遅延が30秒以内
- [ ] 話者識別が正確（誤割り当てなし）

---

**テスト完了:** ⬜ 合格 / ⬜ 不合格

**テスト担当者:** ________________

**日付:** ________________

**署名:** ________________

