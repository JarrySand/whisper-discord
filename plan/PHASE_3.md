# ğŸ”— Phase 3: Botâ‡”API çµåˆ

> **ç›®æ¨™**: Discord Bot ã¨ Whisper API ã‚’é€£æºã•ã›ã€å®‰å®šã—ãŸæ–‡å­—èµ·ã“ã—ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰
>
> **æœŸé–“ç›®å®‰**: 2-3æ—¥
>
> **ä»•æ§˜æ›¸**: [05-integration.md](../docs/details/05-integration.md)

---

## ğŸ“¦ è¿½åŠ ä¾å­˜é–¢ä¿‚

Phase 3 é–‹å§‹æ™‚ã«ä»¥ä¸‹ã‚’ Bot å´ã«è¿½åŠ :

```bash
pnpm add axios form-data
pnpm add -D @types/form-data
```

---

## ğŸ“‹ ã‚¿ã‚¹ã‚¯ä¸€è¦§

### 3.1 Whisper ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£… (Day 1)

#### ã‚¿ã‚¹ã‚¯

- [ ] **T-3.1.1**: WhisperClient ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] **T-3.1.2**: transcribe ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå˜ä¸€ï¼‰
- [ ] **T-3.1.3**: transcribeBatch ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆè¤‡æ•°ï¼‰
- [ ] **T-3.1.4**: healthCheck ãƒ¡ã‚½ãƒƒãƒ‰
- [ ] **T-3.1.5**: ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…

#### å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ

```typescript
// api/whisper-client.ts
class WhisperClient {
  async transcribe(request: TranscribeRequest): Promise<TranscribeResponse> {
    const formData = new FormData();
    formData.append('audio_file', request.audioData, {
      filename: `segment.${request.audioFormat}`,
    });
    formData.append('user_id', request.userId);
    // ...

    return this.executeWithRetry(async () => {
      const response = await this.client.post('/transcribe', formData);
      return response.data;
    });
  }
}
```

#### ãƒªãƒˆãƒ©ã‚¤è¨­å®š

| è¨­å®š | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
|------|-------------|
| retryCount | 3 |
| retryDelay | 1000ms |
| retryBackoffMultiplier | 2 |
| timeout | 60000ms |

#### æ¤œè¨¼é …ç›®

- [ ] æ­£å¸¸ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æ–‡å­—èµ·ã“ã—å–å¾—
- [ ] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã«ãƒªãƒˆãƒ©ã‚¤
- [ ] 4xx ã‚¨ãƒ©ãƒ¼ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„

---

### 3.2 å‡¦ç†ã‚­ãƒ¥ãƒ¼å®Ÿè£… (Day 1-2)

#### ã‚¿ã‚¹ã‚¯

- [ ] **T-3.2.1**: TranscriptionQueue ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] **T-3.2.2**: enqueue ãƒ¡ã‚½ãƒƒãƒ‰
- [ ] **T-3.2.3**: å„ªå…ˆåº¦ä»˜ãã‚­ãƒ¥ãƒ¼
- [ ] **T-3.2.4**: ä¸¦è¡Œå‡¦ç†åˆ¶å¾¡
- [ ] **T-3.2.5**: ã‚¤ãƒ™ãƒ³ãƒˆã‚¨ãƒŸãƒƒã‚¿ãƒ¼ï¼ˆcompleted, failedï¼‰

#### ã‚­ãƒ¥ãƒ¼è¨­å®š

```typescript
interface QueueConfig {
  maxSize: number;        // 100
  maxRetries: number;     // 3
  concurrency: number;    // 2
  processingTimeout: number; // 120000ms
}
```

#### ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼

```
ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   å®Œäº†    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Queue  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Output  â”‚
â”‚ enqueue â”‚           â”‚ Manager â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                      â”‚
    â–¼ å¤±æ•—                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Retry   â”‚          â”‚ Discord â”‚
â”‚ Queue   â”‚          â”‚ File    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ JSON    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3.3 ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ (Day 2)

#### ã‚¿ã‚¹ã‚¯

- [ ] **T-3.3.1**: CircuitBreaker ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] **T-3.3.2**: CLOSED / OPEN / HALF_OPEN çŠ¶æ…‹ç®¡ç†
- [ ] **T-3.3.3**: å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆãƒ»å›å¾©ãƒ­ã‚¸ãƒƒã‚¯
- [ ] **T-3.3.4**: çŠ¶æ…‹é·ç§»ã‚¤ãƒ™ãƒ³ãƒˆ

#### çŠ¶æ…‹é·ç§»

```
CLOSED â”€â”€(å¤±æ•—5å›)â”€â”€â†’ OPEN â”€â”€(30ç§’å¾Œ)â”€â”€â†’ HALF_OPEN
   â†‘                                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(æˆåŠŸ3å›)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼è¨­å®š

```typescript
interface CircuitBreakerConfig {
  failureThreshold: number;   // 5
  successThreshold: number;   // 3
  timeout: number;            // 30000ms
}
```

---

### 3.4 ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° (Day 2)

#### ã‚¿ã‚¹ã‚¯

- [ ] **T-3.4.1**: HealthMonitor ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] **T-3.4.2**: å®šæœŸãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- [ ] **T-3.4.3**: healthy/unhealthy ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
- [ ] **T-3.4.4**: çµ±è¨ˆæƒ…å ±åé›†

#### ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨­å®š

```typescript
interface HealthMonitorConfig {
  checkInterval: number;      // 30000ms
  healthyThreshold: number;   // 2å›é€£ç¶šæˆåŠŸ
  unhealthyThreshold: number; // 3å›é€£ç¶šå¤±æ•—
}
```

---

### 3.5 TranscriptionService çµ±åˆ (Day 2-3)

#### ã‚¿ã‚¹ã‚¯

- [ ] **T-3.5.1**: TranscriptionService ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] **T-3.5.2**: WhisperClient + Queue + CircuitBreaker çµ±åˆ
- [ ] **T-3.5.3**: start / stop ãƒ¡ã‚½ãƒƒãƒ‰
- [ ] **T-3.5.4**: transcribe ãƒ¡ã‚½ãƒƒãƒ‰
- [ ] **T-3.5.5**: getStatus ãƒ¡ã‚½ãƒƒãƒ‰

#### ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆ

```typescript
class TranscriptionService {
  private whisperClient: WhisperClient;
  private queue: TranscriptionQueue;
  private circuitBreaker: CircuitBreaker;
  private healthMonitor: HealthMonitor;
  private outputManager: OutputManager;

  async start(sessionContext: SessionContext): Promise<void> {
    await this.outputManager.startSession(sessionContext);
    this.healthMonitor.start();
    this.queue.start();
  }

  async transcribe(segment: AudioSegment): Promise<void> {
    if (this.circuitBreaker.isOpen()) {
      // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰
      return;
    }
    this.queue.enqueue(segment);
  }
}
```

---

### 3.6 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° (Day 3)

#### ã‚¿ã‚¹ã‚¯

- [ ] **T-3.6.1**: OfflineHandler ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] **T-3.6.2**: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
- [ ] **T-3.6.3**: å¾©æ—§æ™‚ã®å†å‡¦ç†
- [ ] **T-3.6.4**: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç®¡ç†

#### ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼

```
API ãƒ€ã‚¦ãƒ³æ¤œçŸ¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OfflineHandler  â”‚
â”‚ saveForLater()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
./offline_queue/segment-xxx.json

    ... API å¾©æ—§ ...

API å¾©æ—§æ¤œçŸ¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OfflineHandler  â”‚
â”‚ processQueue()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
é€šå¸¸å‡¦ç†ã«æˆ»ã‚‹
```

---

### 3.7 ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›† (Day 3)

#### ã‚¿ã‚¹ã‚¯

- [ ] **T-3.7.1**: MetricsCollector ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] **T-3.7.2**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æˆåŠŸ/å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆ
- [ ] **T-3.7.3**: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·çµ±è¨ˆ
- [ ] **T-3.7.4**: getMetrics ãƒ¡ã‚½ãƒƒãƒ‰

#### åé›†ãƒ¡ãƒˆãƒªã‚¯ã‚¹

```typescript
interface TranscriptionMetrics {
  totalRequests: number;
  successfulRequests: number;
  failedRequests: number;
  avgProcessingTimeMs: number;
  p95ProcessingTimeMs: number;
  errorRate: number;
  currentQueueLength: number;
}
```

---

## ğŸ§ª Phase 3 å®Œäº†ãƒ†ã‚¹ãƒˆ

### å˜ä½“ãƒ†ã‚¹ãƒˆ

- [ ] WhisperClient ãƒ†ã‚¹ãƒˆ
  - [ ] æ­£å¸¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  - [ ] ãƒªãƒˆãƒ©ã‚¤å‹•ä½œ
  - [ ] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- [ ] TranscriptionQueue ãƒ†ã‚¹ãƒˆ
  - [ ] ã‚­ãƒ¥ãƒ¼è¿½åŠ /å‡¦ç†
  - [ ] ä¸¦è¡Œå‡¦ç†åˆ¶é™
- [ ] CircuitBreaker ãƒ†ã‚¹ãƒˆ
  - [ ] çŠ¶æ…‹é·ç§»

### çµåˆãƒ†ã‚¹ãƒˆ

- [ ] Bot â†’ API â†’ çµæœå–å¾— ã®ä¸€é€£ãƒ•ãƒ­ãƒ¼
- [ ] API åœæ­¢æ™‚ã®ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼å‹•ä½œ
- [ ] API å¾©æ—§æ™‚ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼å‡¦ç†

### è² è·ãƒ†ã‚¹ãƒˆ

```
ã‚·ãƒŠãƒªã‚ª:
1. 3äººã§åŒæ™‚ã«ç™ºè©±
2. 10ç§’é–“ç¶™ç¶š
3. å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. é…å»¶ãŒ30ç§’ä»¥å†…ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
```

---

## ğŸ“ æˆæœç‰©ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
bot/src/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ whisper-client.ts     # Whisper API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ queue.ts              # å‡¦ç†ã‚­ãƒ¥ãƒ¼
â”‚   â”œâ”€â”€ circuit-breaker.ts    # ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼
â”‚   â”œâ”€â”€ health-monitor.ts     # ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
â”‚   â”œâ”€â”€ offline-handler.ts    # ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
â”‚   â””â”€â”€ metrics.ts            # ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
â”œâ”€â”€ services/
â”‚   â””â”€â”€ transcription-service.ts  # çµ±åˆã‚µãƒ¼ãƒ“ã‚¹
â””â”€â”€ ...
```

---

## âš ï¸ æ³¨æ„äº‹é …

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š

```
Whisper API å‡¦ç†æ™‚é–“ï¼ˆç›®å®‰ï¼‰:
- 3ç§’éŸ³å£° â†’ 5-15ç§’å‡¦ç†ï¼ˆCPUï¼‰
- 10ç§’éŸ³å£° â†’ 15-60ç§’å‡¦ç†ï¼ˆCPUï¼‰

â†’ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ 60-120ç§’ ã«è¨­å®š
```

### ä¸¦è¡Œå‡¦ç†

```
æ¨å¥¨è¨­å®š:
- Queue concurrency: 2
- ç†ç”±: Whisper ã¯ GPU/CPU ã‚’å æœ‰ã™ã‚‹ãŸã‚ã€
        ä¸¦åˆ—åº¦ã‚’ä¸Šã’ã¦ã‚‚åŠ¹æœãŒè–„ã„
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| ã‚¨ãƒ©ãƒ¼ | å¯¾å¿œ |
|--------|------|
| 4xx ã‚¨ãƒ©ãƒ¼ | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¹ã‚­ãƒƒãƒ— |
| 5xx ã‚¨ãƒ©ãƒ¼ | ãƒªãƒˆãƒ©ã‚¤ï¼ˆ3å›ã¾ã§ï¼‰ |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ãƒªãƒˆãƒ©ã‚¤ï¼ˆ3å›ã¾ã§ï¼‰ |
| æ¥ç¶šã‚¨ãƒ©ãƒ¼ | ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ç™ºå‹• |

---

## ğŸ“Š ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Audio   â”‚     â”‚Transcriptionâ”‚    â”‚  Whisper  â”‚     â”‚   Output   â”‚
â”‚Segmenter â”‚     â”‚  Service   â”‚     â”‚   API     â”‚     â”‚  Manager   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚ segment          â”‚                  â”‚                  â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                  â”‚
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚                  â”‚ enqueue          â”‚                  â”‚
     â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                  â”‚
     â”‚                  â”‚        â”‚         â”‚                  â”‚
     â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                  â”‚
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚                  â”‚ POST /transcribe â”‚                  â”‚
     â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚                  â”‚                  â”‚  inference       â”‚
     â”‚                  â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚                  â”‚                  â”‚       â”‚          â”‚
     â”‚                  â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚                  â”‚   JSON response  â”‚                  â”‚
     â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚                  â”‚ output(result)   â”‚                  â”‚
     â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                  â”‚                  â”‚                  â”‚
```

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: [Phase 4 - å‡ºåŠ› & å®‰å®šåŒ–](./PHASE_4.md)

